## 实习
### 主要工作
我们组的ue使用的是腾讯开源的unlua，用lua去进行ue的代码编写。我的工作则是完善技术中心开发的lua profiler雏形以便于在项目中使用。

这个lua profiler有趣的地方在他除了跨平台侦测lua开销以外，对手机平台的侦测采用的是原创模式，也就是不连数据线到电脑（也导致了许多麻烦）
1. 大幅度改善了工具的前端界面以便于使用
2. 解决了部分内存开销问题（原profiler在每一帧抓到函数开销并储存后，不会删除这个函数的信息，导致即使一个函数只出现了一次，在后续的几千帧里面都会有那个函数的节点在占用内存）
3. 增加了对lua信息的收集和传递（GC状态，还有用户插在代码里面的event）
4. 由于lua函数本质是匿名函数，在我们的unlua框架内，没办法直接通过callinfo / lua_debug去查找函数名。这里由于函数名实际上还是在栈内，所以我找了很久后使用了源码里面的global func name函数达到效果。（find global func name 函数实际上是对整个lua虚拟机的所有函数table去进行检索，不过开销其实还好因为找到后会储存到hash里面）
5. 为了remote的截图功能，写了一个ue的插件作用于在ue内截图。并且通过改profiler框架把从ue存的数据传到手机测的sdk，然后再通过框架转到profiler侧。截图功能参考了pixelstreaming, 不过由于readsurfacedata 开销确实很大，这里尝试了用mapstagingsurface导出后缓存原始数据，跑得很快，可惜手机的opengl没办法运行这个函数。

### 工作上的学习
这个profiler的结构主要是分为三部分，1) profiler    2) 注入在目标客户端的sdk   3) 目标客户端

实习的时候为了更了解profiler，有读一些关于底层实现的书，和部分lua的源码。在进行gc数据收集（加上改写hook），和函数名导出上用处非常大，因为网上完全搜不到该怎么导出这些“匿名”的函数名。其实如果不通过lua源码里面的findglobalfuncname，单纯的在c里把指令debug.traceback推进去lua虚拟机也可以找到函数名，这很有趣。

这份工作最大的挑战还是截图功能。我们的profiler在远程（手机侧）的sdk是raw c++，功能并不是很多。如果没有root的话基本没有办法得到后缓存。这里稍微看了一下java native和opengl，完全没有帮助。这里其实很多截图方式都是需要adb，也就是连线的，远程的话基本没有什么说法在网上。因为不想增加依赖性所有在sdk这里琢磨了很久，最后还是决定从ue获取截图。UE这里的话最简单的方式就是抓ue的后缓存，然后转成图片，这里也是参考了PixelStreaming，无奈readsurfacedata实在太慢。虽然截图能传到profiler了，但是连续截图效率还是低，可惜没有完成就要开始做mini

### Mini
魔方的超新星是维持4周的一个单人mini项目，这次题目是场景交互。我这里很直观的想到横向卷轴解谜，人物去控制地图上的箱子用比较物理的方式去解谜，然后在上面增加元素互动。我的想法很快的就实践了，不过中期答辩的时候了解到gameplay虽然有了，但技术还不够，于是我打算在后面的10天左右的时间做一个水体模拟。

这里为了“场景交互”的题目，打算让可交互的水体能对游戏造成影响，这里考虑的是结冰。也就是我通过控制小箱子拨动水，当水形成浪了后结冰，然后人物就可以跑到更高的位置。

水体模拟采取的是sph物理模拟，用niagara去模拟。 niagara粒子模拟完之后，打到一个面向摄像机的grid2d上面，然后往里面通过wpo改位置。之所以要打到2d grid上是因为粒子对水这种透明物质很难直接的去表现。

在模拟粒子的同时，我使用了一个渲染目标去储存x轴上每个unit x的最高粒子的高度，因为贴图是可以从gpu导出的，于是我可以在外部用蓝图去读这个高度图去生成隐形台阶。
